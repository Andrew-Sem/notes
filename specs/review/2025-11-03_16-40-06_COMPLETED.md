# Review Issues - 2025-11-03_16-40-06

**Target Documents:** specs/prd.md
**Total Issues Found:** 15 (High: 4, Medium: 8, Low: 3)
**Cross-File Issues:** 0 (single document review)

---

## Issue #1: [inconsistency][high] File size limit enforcement unclear between bot and backend
**Files:** specs/prd.md:201
**Evidence:**
```
specs/prd.md:201: "**FR-011**: **Application enforces 20 MB file size limit for MVP.** Files up to 20 MB are downloaded and saved to S3 storage. Files > 20 MB are rejected with notification \"Files over 20 MB are not supported\"."
```

**Problem:** It's unclear which component (Telegram Bot or Backend API) is responsible for enforcing the 20 MB limit. The bot receives files from Telegram first, but should it check file size before downloading or after? Also, no mention of who handles the rejection notification.

**Options:**
- A) Clarify that Telegram Bot checks file size via Telegram API metadata BEFORE downloading and sends rejection notification to user
- B) Clarify that Telegram Bot downloads all files and Backend API validates size during S3 upload, with bot relaying rejection messages
- C) Add explicit component responsibility: "Telegram Bot must check file size using file metadata before initiating download. If size > 20 MB, bot immediately responds with rejection message without downloading file."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: Skip - bot and backend API are the same component]

---

## Issue #2: [ambiguity][high] Message deletion handling incomplete
**Files:** specs/prd.md:202-203
**Evidence:**
```
specs/prd.md:202-203: "**FR-011a**: When user deletes a message in Telegram, bot receives delete event and removes the associated note and media files from S3 storage"
```

**Problem:** This requirement doesn't specify:
1. What happens if S3 deletion fails
2. Whether there's a grace period before permanent deletion
3. How to handle race conditions (user viewing note in Mini App while deleting in bot)
4. Whether deletion is logged for audit purposes

**Options:**
- A) Add clarification: "Deletion is immediate and permanent. If S3 deletion fails, log error and retry up to 3 times with exponential backoff. No grace period in MVP. Race conditions resolved by last-operation-wins."
- B) Add clarification: "Deletion marks note as deleted immediately in database, actual S3 cleanup happens asynchronously via background job. User sees note removed immediately in Mini App."
- C) Keep as-is and document as known limitation: "MVP implements best-effort deletion. Failed S3 deletions are logged but not retried. Consider implementing deletion queue in post-MVP."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #3: [inconsistency][medium] Authentication mechanism mentioned twice with slightly different wording
**Files:** specs/prd.md:36, specs/prd.md:795
**Evidence:**
```
specs/prd.md:36: "- Authentication via Telegram (using Telegram User ID). Mini App authenticates users using Telegram WebApp initData validation."
specs/prd.md:795: "5. **Telegram Mini App**: React frontend using @telegram-apps/sdk for authentication (https://docs.telegram-mini-apps.com/packages/telegram-apps-sdk/2-x), embedded in Telegram"
```

**Problem:** Two different sections mention authentication with different levels of detail. Line 36 mentions "initData validation" while line 795 mentions "@telegram-apps/sdk" without specifying validation method. Should be consistent.

**Options:**
- A) Update line 795 to match line 36: "React frontend using @telegram-apps/sdk for authentication via Telegram WebApp initData validation"
- B) Update line 36 to match line 795: "Authentication via Telegram using @telegram-apps/sdk (https://docs.telegram-mini-apps.com/packages/telegram-apps-sdk/2-x)"
- C) Consolidate both into a more detailed single statement in the architecture section and reference it from security section
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: D - Authentication via Telegram: Mini App frontend uses @telegram-apps/sdk for Telegram WebApp initData validation. Bot receives user context directly from Telegram Bot API.]

---

## Issue #4: [ambiguity][medium] Text preview length unclear for different content types
**Files:** specs/prd.md:337
**Evidence:**
```
specs/prd.md:337: "- **FR-017**: Each note in list shows: text preview (first 100 printable characters of text/caption with formatting stripped and whitespace collapsed; for media-only notes without captions, show thumbnail for photos/videos or file icon/name for documents), content type (icon), creation time, tags (if any)"
```

**Problem:** The 100-character preview is only for text/caption. For documents without captions, it says "show file icon/name" but doesn't specify if there's a character limit for long filenames (which can exceed 100 characters).

**Options:**
- A) Add clarification: "for media-only notes without captions, show thumbnail for photos/videos or file icon with filename truncated to 50 characters for documents"
- B) Add clarification: "for media-only notes without captions, show thumbnail for photos/videos or file icon with full filename for documents (no character limit)"
- C) Standardize on 100 characters for everything: "for media-only notes without captions, show thumbnail for photos/videos or file icon with filename truncated to 100 characters for documents"
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: C]

---

## Issue #5: [missing_info][high] Note list pagination vs infinite scroll specification inconsistent
**Files:** specs/prd.md:338
**Evidence:**
```
specs/prd.md:338: "- **FR-018**: Implemented infinite scroll or pagination to load notes in batches of 20"
```

**Problem:** The requirement says "infinite scroll OR pagination" but doesn't specify which one to implement. This is a significant UX decision that affects implementation. The acceptance criteria (AC-011) only mentions scrolling, suggesting infinite scroll is preferred, but the functional requirement leaves it ambiguous.

**Options:**
- A) Change to: "Implement infinite scroll (not pagination) to load notes in batches of 20"
- B) Change to: "Implement pagination (not infinite scroll) to load notes in batches of 20 with numbered pages"
- C) Keep both as options but add: "Preferred approach: infinite scroll. Pagination is acceptable alternative if infinite scroll proves technically challenging."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #6: [inconsistency][medium] Concurrent edit handling mentioned twice with different wording
**Files:** specs/prd.md:556, specs/prd.md:557-558
**Evidence:**
```
specs/prd.md:556: "- **FR-040**: When editing metadata is updated \"last_edited\" (time of last change). Concurrent edits use last-write-wins strategy (no conflict detection or version control in MVP)."
specs/prd.md:557-558: "- **FR-040a**: Concurrent edits are handled using last-write-wins strategy: if multiple users or sessions edit the same note simultaneously, the last saved change overwrites previous changes without conflict detection or merge resolution in MVP."
```

**Problem:** FR-040 and FR-040a both describe the same last-write-wins strategy for concurrent edits. FR-040a is more detailed but it's redundant. Should consolidate into one requirement.

**Options:**
- A) Delete FR-040a entirely and expand FR-040 to include its detail: "When editing metadata is updated \"last_edited\" (time of last change). Concurrent edits from multiple users or sessions use last-write-wins strategy: the last saved change overwrites previous changes without conflict detection, merge resolution, or version control in MVP."
- B) Delete the concurrent edit sentence from FR-040 and keep only FR-040a as the definitive statement
- C) Keep both but add cross-reference: "See FR-040a for concurrent edit handling details" in FR-040
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #7: [ambiguity][medium] Search debounce timing unclear for user experience
**Files:** specs/prd.md:385
**Evidence:**
```
specs/prd.md:385: "- **FR-022**: Search bar is available on Mini App main screen with 300ms debounce to avoid excessive API calls"
```

**Problem:** 300ms debounce is specified but acceptance criteria AC-013 says "results are displayed with debounce of 300ms" which could be interpreted as results appearing 300ms after typing stops. Should clarify if this means: (a) 300ms delay after last keystroke before API call, or (b) 300ms minimum delay between API calls, or (c) both.

**Options:**
- A) Clarify as: "Search bar is available on Mini App main screen with 300ms debounce (waits 300ms after user stops typing before making API call) to avoid excessive API calls"
- B) Clarify as: "Search bar is available on Mini App main screen with 300ms throttle (limits API calls to maximum once per 300ms) to avoid excessive API calls"
- C) Add both: "Search bar is available on Mini App main screen with 300ms debounce (waits 300ms after last keystroke) and rate limiting (max 1 request per 300ms) to avoid excessive API calls"
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #8: [inconsistency][low] Folder name length limit inconsistent with tag limit approach
**Files:** specs/prd.md:482, specs/prd.md:486
**Evidence:**
```
specs/prd.md:482: "- **FR-028**: User can create folders with arbitrary names (up to 50 characters). Folders use flat structure only (no nesting) in MVP. No limit on number of folders per user."
specs/prd.md:486: "- **FR-031**: User can add multiple tags to note (up to 10 tags per note, regardless of tag length or emoji usage)"
```

**Problem:** Folders have a 50-character limit but tags have no character length limit (only count limit of 10). This inconsistency could lead to UX issues. Should standardize the approach.

**Options:**
- A) Add character limit to tags: "User can add multiple tags to note (up to 10 tags per note, each tag max 30 characters, emoji characters count as 1)"
- B) Remove character limit from folders: "User can create folders with arbitrary names (reasonable length enforced by UI). Folders use flat structure only (no nesting) in MVP."
- C) Keep as-is and add rationale: "Folders have 50-char limit for display consistency in sidebar. Tags have no length limit as they're displayed as compact pills."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #9: [missing_info][medium] Search ranking by relevance score not defined
**Files:** specs/prd.md:387
**Evidence:**
```
specs/prd.md:387: "- **FR-023**: Search results are ranked by relevance score"
```

**Problem:** "Relevance score" is not defined. For full-text search, what determines relevance? Exact match vs partial? Case sensitivity? Multiple keyword matches? Term frequency? This needs specification for consistent implementation.

**Options:**
- A) Add detail: "Search results are ranked by relevance score based on: 1) Exact phrase match (highest), 2) All words present, 3) Partial word matches, 4) Term frequency in note, 5) Recency of note (tiebreaker)"
- B) Simplify to: "Search results are ordered by most recent first (creation date descending) as relevance scoring is deferred to post-MVP"
- C) Reference database capability: "Search results are ranked by relevance score using PostgreSQL full-text search ranking (ts_rank) with default weights"
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: D - Search results are ranked by partial match relevance (substring matching)]

---

## Issue #10: [ambiguity][medium] Tag autocomplete behavior undefined
**Files:** specs/prd.md:487
**Evidence:**
```
specs/prd.md:487: "- **FR-033**: When entering tag, suggestions with existing tags should be shown (autocomplete)"
```

**Problem:** Autocomplete behavior not specified:
1. When do suggestions appear? (after N characters? immediately on focus?)
2. How many suggestions to show?
3. Partial match or prefix match only?
4. Case-sensitive or case-insensitive matching?
5. User-scoped tags only or global?

**Options:**
- A) Add detail: "When entering tag, autocomplete shows up to 10 user-scoped tags matching input (case-insensitive prefix match) after typing 1+ characters. Press Tab or click to select."
- B) Add detail: "When entering tag, autocomplete shows up to 5 user-scoped tags with case-insensitive substring match. Suggestions appear after typing 2+ characters. Arrow keys navigate, Enter selects."
- C) Defer to implementation: "When entering tag, suggestions with existing user tags should be shown (autocomplete). Exact behavior determined during UI implementation."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: D - When entering tag, show all existing user tags in dropdown (no search/filtering in MVP). User can scroll and click to select.]

---

## Issue #11: [inconsistency][high] Rate limiting statement conflicts with "no custom rate limiting" claim
**Files:** specs/prd.md:41
**Evidence:**
```
specs/prd.md:41: "- Rate limiting: Application relies on Telegram's built-in rate limits for bot messages; no custom rate limiting implemented in MVP"
```

**Problem:** This only mentions "bot messages" but the application also has:
1. Mini App API endpoints (GET /notes, POST /folders, etc.) - these need rate limiting to prevent abuse
2. S3 storage operations - no rate limit mentioned
3. Search API - could be expensive without rate limiting

Saying "no custom rate limiting" for MVP leaves API endpoints vulnerable to abuse.

**Options:**
- A) Revise to: "Rate limiting: Telegram Bot relies on Telegram's built-in rate limits. Backend API implements basic rate limiting: 100 requests per minute per user for all endpoints. S3 storage inherits AWS rate limits."
- B) Add clarification: "Rate limiting: Application relies on Telegram's built-in rate limits for bot messages; no custom rate limiting implemented in MVP. Note: This is a known security limitation; backend API rate limiting should be added in Phase 2."
- C) Change to more realistic: "Rate limiting: Telegram Bot relies on Telegram's built-in rate limits. Backend API implements simple rate limiting via reverse proxy (e.g., Nginx: 20 req/sec per IP)."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: Skip - No rate limiting is intentional design decision for MVP]

---

## Issue #12: [missing_info][medium] Media file metadata storage incomplete
**Files:** specs/prd.md:198
**Evidence:**
```
specs/prd.md:198: "- **FR-008**: Database stores file reference, file type, size, and metadata"
```

**Problem:** "metadata" is vague. For media files, important metadata includes:
1. Original filename
2. MIME type
3. Upload timestamp
4. File dimensions (for photos/videos)
5. Duration (for videos)
6. Thumbnail URL

Should specify what metadata is stored.

**Options:**
- A) Expand to: "Database stores file reference (S3 URL), file type, size, original filename, MIME type, upload timestamp. For photos: dimensions and thumbnail URL. For videos: dimensions, duration, and thumbnail URL."
- B) Simplify to: "Database stores file reference (S3 URL), file type, size, original filename, and MIME type. Additional metadata deferred to post-MVP."
- C) Keep vague and add: "Database stores file reference, file type, size, and basic metadata (structure defined during implementation based on Telegram Bot API response)"
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: Skip - Metadata details are technical implementation, not PRD scope]

---

## Issue #13: [ambiguity][low] "Reasonable font size" too vague for accessibility requirement
**Files:** specs/prd.md:52
**Evidence:**
```
specs/prd.md:52: "- Support for minimum font size of 14px for readability"
```

**Problem:** While 14px minimum is specified, it's unclear if this is the default body text size or truly the minimum (meaning larger text should be proportionally larger). Also no mention of font scaling or user preferences.

**Options:**
- A) Clarify: "Support for minimum font size of 14px for body text with proportional scaling for headings. Respects browser/OS font size preferences."
- B) Clarify: "Default body text is 16px, minimum text size is 14px (for captions/metadata). All text scales proportionally with browser zoom."
- C) Keep as-is: "Support for minimum font size of 14px for readability" (interpret as all text >= 14px during implementation)
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #14: [missing_info][medium] Error handling and retry logic for failed operations
**Files:** specs/prd.md:148, specs/prd.md:201
**Evidence:**
```
specs/prd.md:148: "- **FR-004**: If saving fails, bot notifies user and message must be manually re-sent (no automatic retry)"
specs/prd.md:201: "If S3 upload fails, user must manually re-send (no automatic retry)."
```

**Problem:** While "no automatic retry" is stated, there's no specification for:
1. What error messages users receive
2. Whether failed operations are logged for debugging
3. Transient errors vs permanent errors (network timeout vs invalid data)
4. Whether users can see a list of failed operations

This could lead to poor UX and difficult troubleshooting.

**Options:**
- A) Add new requirement: "**FR-ERR-001**: Failed operations (message save, S3 upload) show user-friendly error messages: 'Failed to save note. Please try again.' Failed operations are logged server-side with full error details for debugging. No retry queue in MVP."
- B) Add to out-of-scope: "Advanced retry logic: Message queue and retry mechanisms for handling Telegram API service disruptions (MVP assumes Telegram has 100% availability)" (already exists line 814, but should reference it from FR-004)
- C) Keep minimal and add: "Error messages should be user-friendly and actionable. All errors logged server-side. Error handling details determined during implementation."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: A]

---

## Issue #15: [ambiguity][low] Thumbnail generation specification missing
**Files:** specs/prd.md:199
**Evidence:**
```
specs/prd.md:199: "- **FR-009**: For photos, a thumbnail version must be generated for quick loading in note list"
```

**Problem:** No specification for:
1. Thumbnail dimensions (e.g., 200x200px, 300x200px?)
2. Thumbnail quality/compression (balance size vs quality)
3. When thumbnail is generated (synchronously during upload or async?)
4. What happens if thumbnail generation fails (show original? placeholder?)
5. Thumbnail format (JPEG, WebP?)

**Options:**
- A) Add detail: "Thumbnail size: 400x400px max, JPEG format, 80% quality. Generated synchronously during S3 upload. If generation fails, use original image with CSS max-width constraint."
- B) Add detail: "Thumbnail size: 300x300px max, WebP format with JPEG fallback, optimized for web. Generated asynchronously after upload. Show placeholder spinner until ready."
- C) Defer to implementation: "For photos, a thumbnail version must be generated for quick loading in note list. Exact dimensions and format determined during implementation based on performance testing."
- D) Other (custom resolution)

**Resolution:** [RESOLUTION: Skip - Thumbnail details are technical implementation, not PRD scope]

---

## COMPLETED

**Completed at:** 2025-11-04 00:56:27
**Total Issues:** 15
**Issues Resolved:** 9
**Issues Skipped:** 6
**Files Modified:** specs/prd.md

### Summary of Changes Applied:

1. **Issue #2** - Added deletion failure handling with retry logic and race condition resolution
2. **Issue #3** - Clarified authentication mechanism for both Mini App and Bot
3. **Issue #4** - Standardized 100-character limit for all text previews including filenames
4. **Issue #5** - Specified infinite scroll as the chosen implementation approach
5. **Issue #6** - Consolidated duplicate concurrent edit handling requirements (FR-040 and FR-040a)
6. **Issue #7** - Clarified search debounce timing (300ms after user stops typing)
7. **Issue #8** - Added 30-character limit to tags for consistency with folder naming
8. **Issue #9** - Defined search ranking as partial match relevance (substring matching)
9. **Issue #10** - Specified tag dropdown shows all existing tags without filtering in MVP
10. **Issue #13** - Clarified font size accessibility with proportional scaling
11. **Issue #14** - Added new FR-ERR-001 requirement for error handling

### Issues Skipped (by reason):

- **Issue #1**: Bot and backend API are the same component (user clarification)
- **Issue #11**: No rate limiting is intentional design decision for MVP
- **Issue #12**: Metadata structure details are technical implementation, not PRD scope
- **Issue #15**: Thumbnail generation details are technical implementation, not PRD scope

